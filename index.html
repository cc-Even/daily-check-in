<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ›æ‰£æ‰“å¡ç³»ç»Ÿ</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

    body {
    background: linear-gradient(135deg, #00BCD4, #9C27B0, #E91E63);
    min-height: 100vh;
    font-family: 'Arial', sans-serif;
    padding: 1rem;
}

    .container {
    max-width: 1200px;
    margin: 0 auto;
}

    .header {
    text-align: center;
    margin-bottom: 2rem;
    color: white;
}

    .header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

    .header p {
    font-size: 1.2rem;
    opacity: 0.9;
}

    .nav-tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 0.5rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(10px);
    border: 4px solid rgba(255, 255, 255, 0.3);
}

    .nav-tab {
    flex: 1;
    padding: 1rem;
    border-radius: 16px;
    text-align: center;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
}

    .nav-tab.active {
    background: white;
    color: #9C27B0;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

    .nav-tab:not(.active):hover {
    background: rgba(255, 255, 255, 0.3);
}

    .card {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(10px);
    border: 4px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

    .card h3 {
    color: white;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    font-size: 1.5rem;
}

    .card h3 i {
    margin-right: 0.5rem;
}

    .person-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

    .person-item {
    padding: 1.5rem;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 4px solid transparent;
    text-align: center;
}

    .person-item.selected {
    border-color: #FFEB3B;
    background: linear-gradient(135deg, #FFCDD2, #F8BBD9);
}

    .person-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    margin: 0 auto 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.5rem;
    color: white;
}

    .person-name {
    color: white;
    font-weight: bold;
}

    .upload-area {
    position: relative;
    margin-bottom: 1rem;
}

    .upload-label {
    display: block;
    width: 100%;
    padding: 2rem;
    border: 4px dashed rgba(255, 255, 255, 0.5);
    border-radius: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
}

    .upload-label:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.8);
}

    .upload-label.has-file {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
}

    .upload-icon {
    font-size: 3rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 1rem;
}

    .upload-label.has-file .upload-icon {
    color: #4CAF50;
}

    .upload-input {
    display: none;
}

    .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

    .status-item {
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    border: 4px solid transparent;
}

    .status-item.completed {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.2);
}

    .status-item.pending {
    border-color: #F44336;
    background: rgba(244, 67, 54, 0.2);
}

    .status-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin: 0 auto 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    color: white;
    margin-bottom: 1rem;
}

    .status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

    .btn {
    width: 100%;
    padding: 1.2rem;
    border: none;
    border-radius: 16px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

    .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

    .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

    .status-message {
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    text-align: center;
}

    .status-success {
    background: rgba(76, 175, 80, 0.3);
    border: 2px solid #4CAF50;
    color: white;
}

    .status-error {
    background: rgba(244, 67, 54, 0.3);
    border: 2px solid #F44336;
    color: white;
}

    .no-token {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 3rem;
    text-align: center;
    color: white;
    backdrop-filter: blur(10px);
    border: 4px solid rgba(255, 255, 255, 0.3);
}

    .no-token i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #FFEB3B;
}

    .code-block {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 12px;
    font-family: monospace;
    font-size: 0.9rem;
    margin: 1rem 0;
    word-break: break-all;
}

    .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

    @keyframes spin {
    to { transform: rotate(360deg); }
}

    .hidden {
    display: none;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>âœ¨ åŠ›æ‰£æ‰“å¡ç³»ç»Ÿ âœ¨</h1>
        <p>æ…å°”ä¼˜æ¸¸ å‹‰å°”éæ€</p>
    </div>

    <div id="noTokenView" class="no-token hidden">
        <i data-lucide="alert-circle"></i>
        <h2>âš ï¸ ç¼ºå°‘è®¿é—®ä»¤ç‰Œ</h2>
        <p>è¯·åœ¨URLä¸­æ·»åŠ tokenå‚æ•°ï¼š</p>
        <div class="code-block">
            http://localhost:8989?token=your_token_here
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="upload">
                ğŸ“¸ ä¸Šä¼ æ‰“å¡
            </div>
            <div class="nav-tab" data-tab="status">
                ğŸ“Š æŸ¥çœ‹çŠ¶æ€
            </div>
        </div>

        <!-- ä¸Šä¼ æ‰“å¡é¡µé¢ -->
        <div id="uploadTab" class="tab-content">
            <!-- é€‰æ‹©äººå‘˜ -->
            <div class="card">
                <h3><i data-lucide="user"></i> é€‰æ‹©æ‰“å¡äººå‘˜</h3>
                <div class="person-grid" id="personGrid">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="card">
                <h3><i data-lucide="camera"></i> ä¸Šä¼ æ‰“å¡å‡­è¯</h3>

                <div class="upload-area">
                    <label for="imageInput" class="upload-label" id="uploadLabel">
                        <i data-lucide="camera" class="upload-icon"></i>
                        <div id="uploadText">
                            <p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</p>
                            <p style="font-size: 0.9rem; opacity: 0.8;">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
                        </div>
                    </label>
                    <input type="file" id="imageInput" class="upload-input" accept="image/*">
                </div>

                <div id="uploadStatus" class="status-message hidden"></div>
                <div id="uploadResult" class="status-message hidden"></div>

                <button id="uploadBtn" class="btn">
                    <span id="uploadBtnText">ğŸ‰ ç¡®è®¤ä¸Šä¼ </span>
                </button>
            </div>
        </div>

        <!-- æŸ¥çœ‹çŠ¶æ€é¡µé¢ -->
        <div id="statusTab" class="tab-content hidden">
            <!-- æ—¥æœŸé€‰æ‹© -->
            <div class="card">
                <h3><i data-lucide="calendar"></i> é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ</h3>
                <input type="date" id="checkDate" class="form-control" style="width: 100%; padding: 1rem; border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white;">
            </div>

            <!-- çŠ¶æ€å±•ç¤º -->
            <div class="card">
                <h3><i data-lucide="bar-chart"></i> <span id="statusTitle">æ‰“å¡çŠ¶æ€</span></h3>
                <div id="loadingStatus" class="text-center py-8 hidden">
                    <div class="loading"></div>
                    <p style="color: white; margin-top: 1rem;">åŠ è½½ä¸­...</p>
                </div>
                <div class="status-grid" id="statusGrid">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ– Lucide å›¾æ ‡
    lucide.createIcons();

    // å…¨å±€å˜é‡
    let token = '';
    let persons = [];
    let selectedPerson = '';
    let imageFile = null;
    let statusData = null;

    // è·å–APIåŸºç¡€URLï¼ˆä½¿ç”¨å½“å‰è®¿é—®çš„ä¸»æœºåœ°å€ï¼‰
    function getBaseUrl() {
        return window.location.origin;
    }

    const API_BASE_URL = getBaseUrl();

    // ä»URLè·å–token
    function getTokenFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('token');
}

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
    token = getTokenFromUrl();

    if (!token) {
    document.getElementById('noTokenView').classList.remove('hidden');
    return;
}

    document.getElementById('mainApp').classList.remove('hidden');
    loadPersons();
}

    // åŠ è½½äººå‘˜åˆ—è¡¨
    async function loadPersons() {
    try {
    showLoading(true);
    const response = await fetch(`${API_BASE_URL}/api/persons?token=${token}`);
    const data = await response.json();

    if (data.code === 200) {
    persons = data.data;
    renderPersons();
    loadStatus();
} else {
    showStatusMessage(data.message || 'è·å–äººå‘˜åˆ—è¡¨å¤±è´¥', 'error');
}
} catch (error) {
    showStatusMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
} finally {
    showLoading(false);
}
}

    // æ¸²æŸ“äººå‘˜åˆ—è¡¨
    function renderPersons() {
    const grid = document.getElementById('personGrid');
    grid.innerHTML = '';

    persons.forEach((person, index) => {
        const colors = ['from-pink-400 to-pink-600', 'from-blue-400 to-blue-600', 'from-green-400 to-green-600', 'from-purple-400 to-purple-600'];
    const colorClass = colors[index % colors.length];

    const item = document.createElement('div');
    item.className = 'person-item';
    item.onclick = () => selectPerson(person.name);

    const avatar = document.createElement('div');
    avatar.className = 'person-avatar';
    // å¦‚æœperson.avatarå­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨person.avatarä½œä¸ºèƒŒæ™¯å›¾ç‰‡
    if (person.avatar) {
    avatar.style.backgroundImage = `url(${person.avatar})`;
    avatar.style.backgroundSize = 'cover';
    avatar.style.backgroundPosition = 'center';
    } else {
        avatar.style.background = `linear-gradient(135deg, #FFCDD2, #F8BBD9)`;
        avatar.textContent = person.name.charAt(0);
    }

    const name = document.createElement('div');
    name.className = 'person-name';
    name.textContent = person.name;

    item.appendChild(avatar);
    item.appendChild(name);
    grid.appendChild(item);
});
}

    // é€‰æ‹©äººå‘˜
    function selectPerson(name) {
    selectedPerson = name;
    document.querySelectorAll('.person-item').forEach(item => {
    item.classList.remove('selected');
});
    event.target.closest('.person-item').classList.add('selected');
}

    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    document.getElementById('imageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
    imageFile = file;
    document.getElementById('uploadLabel').classList.add('has-file');
    document.getElementById('uploadText').innerHTML = `
                    <i data-lucide="upload" style="color: #4CAF50;"></i>
                    <p>${file.name}</p>
                `;
    lucide.createIcons();
    hideStatusMessage();
} else {
    showStatusMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
    this.value = '';
}
});

    // ä¸Šä¼ å›¾ç‰‡
    async function uploadImage() {
    if (!selectedPerson) {
    showStatusMessage('è¯·é€‰æ‹©æ‰“å¡äººå‘˜', 'error');
    return;
}
    if (!imageFile) {
    showStatusMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
}

    try {
    showLoading(true);
    document.getElementById('uploadBtnText').textContent = 'ä¸Šä¼ ä¸­...';
    document.getElementById('uploadBtn').disabled = true;

    const formData = new FormData();
    formData.append('name', selectedPerson);
    formData.append('image', imageFile);

    const response = await fetch(`${API_BASE_URL}/api/upload?token=${token}`, {
    method: 'POST',
    body: formData,
});

    const data = await response.json();

    if (data.code === 200) {
    showUploadResult(data.data);
    imageFile = null;
    document.getElementById('imageInput').value = '';
    document.getElementById('uploadLabel').classList.remove('has-file');
    document.getElementById('uploadText').innerHTML = `
                        <i data-lucide="camera" class="upload-icon"></i>
                        <p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
                    `;
    lucide.createIcons();
    loadStatus(); // åˆ·æ–°çŠ¶æ€
} else {
    showStatusMessage(data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
}
} catch (error) {
    showStatusMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
} finally {
    showLoading(false);
    document.getElementById('uploadBtnText').textContent = 'ğŸ‰ ç¡®è®¤ä¸Šä¼ ';
    document.getElementById('uploadBtn').disabled = false;
}
}

    // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
    function showUploadResult(result) {
    const resultDiv = document.getElementById('uploadResult');
    resultDiv.innerHTML = `
                <i data-lucide="check-circle"></i>
                ${result.name} åœ¨ ${result.date} æ‰“å¡æˆåŠŸï¼
            `;
    resultDiv.className = 'status-message status-success';
    resultDiv.classList.remove('hidden');
    lucide.createIcons();
}

    // åŠ è½½æ‰“å¡çŠ¶æ€
    async function loadStatus() {
    try {
    showLoadingStatus(true);
    const date = document.getElementById('checkDate').value || new Date().toISOString().split('T')[0];

    const response = await fetch(`${API_BASE_URL}/api/status?token=${token}&date=${date}`);
    const data = await response.json();

    if (data.code === 200) {
    statusData = data.data;
    document.getElementById('statusTitle').textContent = `${date} æ‰“å¡çŠ¶æ€`;
    renderStatus();
} else {
    showStatusMessage(data.message || 'è·å–çŠ¶æ€å¤±è´¥', 'error');
}
} catch (error) {
    showStatusMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
} finally {
    showLoadingStatus(false);
}
}

    // æ¸²æŸ“æ‰“å¡çŠ¶æ€
    function renderStatus() {
    const grid = document.getElementById('statusGrid');
    grid.innerHTML = '';

    if (!statusData) return;

    statusData.status.forEach((person, index) => {
    const colors = ['from-pink-400 to-pink-600', 'from-blue-400 to-blue-600', 'from-green-400 to-green-600', 'from-purple-400 to-purple-600'];
    const colorClass = colors[index % colors.length];

    const item = document.createElement('div');
    item.className = `status-item ${person.uploaded ? 'completed' : 'pending'}`;

    const avatar = document.createElement('div');
    avatar.className = 'status-avatar';
    // å¦‚æœperson.avatarå­˜åœ¨ï¼Œä½¿ç”¨å¤´åƒå›¾ç‰‡ï¼Œå¦åˆ™æ˜¾ç¤ºåå­—é¦–å­—æ¯
    if (person.avatar) {
        avatar.style.backgroundImage = `url(${person.avatar})`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
    } else {
        avatar.style.background = `linear-gradient(135deg, #FFCDD2, #F8BBD9)`;
        avatar.textContent = person.name.charAt(0);
    }

    const name = document.createElement('div');
    name.style.color = 'white';
    name.style.fontWeight = 'bold';
    name.textContent = person.name;

    const indicator = document.createElement('div');
    indicator.className = 'status-indicator';
    if (person.uploaded) {
    indicator.innerHTML = `<i data-lucide="check-circle"></i> å·²æ‰“å¡`;
} else {
    indicator.innerHTML = `<i data-lucide="x-circle"></i> æœªæ‰“å¡`;
}

    item.appendChild(avatar);
    item.appendChild(name);
    item.appendChild(indicator);
    grid.appendChild(item);
});

    lucide.createIcons();
}

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.textContent = message;
    statusDiv.className = `status-message status-${type}`;
    statusDiv.classList.remove('hidden');
}

    // éšè—çŠ¶æ€æ¶ˆæ¯
    function hideStatusMessage() {
    document.getElementById('uploadStatus').classList.add('hidden');
}

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(show) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å…¨å±€åŠ è½½çŠ¶æ€é€»è¾‘
}

    // æ˜¾ç¤ºçŠ¶æ€é¡µåŠ è½½
    function showLoadingStatus(show) {
    const loadingEl = document.getElementById('loadingStatus');
    if (show) {
    loadingEl.classList.remove('hidden');
} else {
    loadingEl.classList.add('hidden');
}
}

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');

        // æ›´æ–°æ ‡ç­¾æ ·å¼
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // æ˜¾ç¤ºå¯¹åº”å†…å®¹
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`${targetTab}Tab`).classList.remove('hidden');

        // å¦‚æœåˆ‡æ¢åˆ°çŠ¶æ€é¡µï¼ŒåŠ è½½æ•°æ®
        if (targetTab === 'status') {
            loadStatus();
        }
    });
});

    // ä¸Šä¼ æŒ‰é’®äº‹ä»¶
    document.getElementById('uploadBtn').addEventListener('click', uploadImage);

    // æ—¥æœŸé€‰æ‹©äº‹ä»¶
    document.getElementById('checkDate').addEventListener('change', loadStatus);

    // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
    document.getElementById('checkDate').value = new Date().toLocaleDateString('sv-SE', {timeZone: "Asia/Shanghai"});

    // åº”ç”¨åˆå§‹åŒ–
    window.addEventListener('load', initApp);
</script>
</body>
</html>